var H=Object.defineProperty;var $=(o,t)=>{for(var e in t)H(o,e,{get:t[e],enumerable:!0})};import{Logger as y0}from"@ethersproject/logger";import{Interface as j}from"@fuel-ts/abi-coder";import{randomBytes as g0}from"@fuel-ts/keystore";import{Provider as h0,CreateTransactionRequest as C0}from"@fuel-ts/providers";import{MAX_GAS_PER_TX as A0}from"@fuel-ts/transactions";import{BaseWalletLocked as R0}from"@fuel-ts/wallet";var D={};$(D,{assert:()=>h,getContractId:()=>q,getContractRoot:()=>O,getContractStorageRoot:()=>x,includeHexPrefix:()=>w});import{hexlify as B,arrayify as Z,concat as K}from"@ethersproject/bytes";import{sha256 as Y}from"@ethersproject/sha2";import{calcRoot as t0}from"@fuel-ts/merkle";import e0 from"@fuel-ts/sparsemerkle";var O=o=>{let e=[];for(let n=0;n<o.length;n+=8){let a=new Uint8Array(8);a.set(o.slice(n,n+8)),e.push(a)}return t0(e.map(n=>B(n)))},x=o=>{let t=new e0;return o.forEach(({key:e,value:n})=>t.update(e,n)),t.root},q=(o,t,e)=>{let n=O(Z(o));return Y(K(["0x4655454C",t,n,e]))};function h(o,t){if(!o)throw new Error(t)}var w=(o,t)=>B(o,{...t,allowMissingPrefix:!0});import{Interface as J}from"@fuel-ts/abi-coder";import{Address as m0}from"@fuel-ts/address";import{BaseWalletLocked as f0}from"@fuel-ts/wallet";import{coinQuantityfy as d0}from"@fuel-ts/providers";import{bn as g,toNumber as U}from"@fuel-ts/math";import{transactionRequestify as W,ScriptTransactionRequest as c0}from"@fuel-ts/providers";import{MAX_GAS_PER_TX as l0,InputType as u0}from"@fuel-ts/transactions";import{arrayify as M,concat as V}from"@ethersproject/bytes";import{AbiCoder as E,U64Coder as P}from"@fuel-ts/abi-coder";import{bn as Q,toNumber as I}from"@fuel-ts/math";import{Script as a0}from"@fuel-ts/script";import{ReceiptType as o0}from"@fuel-ts/transactions";var _=[{type:"function",inputs:[{name:"script_data",type:"struct ScriptData",components:[{name:"calls",type:"[enum Option; 5]",components:[{name:"__array_element",type:"enum Option",components:[{name:"None",type:"()",components:[],typeArguments:null},{name:"Some",type:"struct MulticallCall",components:[{name:"contract_id",type:"struct ContractId",components:[{name:"value",type:"b256",components:null,typeArguments:null}],typeArguments:null},{name:"fn_selector",type:"u64",components:null,typeArguments:null},{name:"fn_arg",type:"enum CallValue",components:[{name:"Value",type:"u64",components:null,typeArguments:null},{name:"Data",type:"(u64, u64)",components:[{name:"__tuple_element",type:"u64",components:null,typeArguments:null},{name:"__tuple_element",type:"u64",components:null,typeArguments:null}],typeArguments:null}],typeArguments:null},{name:"parameters",type:"struct CallParameters",components:[{name:"amount",type:"enum Option",components:[{name:"None",type:"()",components:[],typeArguments:null},{name:"Some",type:"u64",components:null,typeArguments:null}],typeArguments:[{name:"T",type:"u64",components:null,typeArguments:null}]},{name:"asset_id",type:"enum Option",components:[{name:"None",type:"()",components:[],typeArguments:null},{name:"Some",type:"struct ContractId",components:[{name:"value",type:"b256",components:null,typeArguments:null}],typeArguments:null}],typeArguments:[{name:"T",type:"struct ContractId",components:[{name:"value",type:"b256",components:null,typeArguments:null}],typeArguments:null}]},{name:"gas",type:"enum Option",components:[{name:"None",type:"()",components:[],typeArguments:null},{name:"Some",type:"u64",components:null,typeArguments:null}],typeArguments:[{name:"T",type:"u64",components:null,typeArguments:null}]}],typeArguments:null}],typeArguments:null}],typeArguments:[{name:"T",type:"struct MulticallCall",components:[{name:"contract_id",type:"struct ContractId",components:[{name:"value",type:"b256",components:null,typeArguments:null}],typeArguments:null},{name:"fn_selector",type:"u64",components:null,typeArguments:null},{name:"fn_arg",type:"enum CallValue",components:[{name:"Value",type:"u64",components:null,typeArguments:null},{name:"Data",type:"(u64, u64)",components:[{name:"__tuple_element",type:"u64",components:null,typeArguments:null},{name:"__tuple_element",type:"u64",components:null,typeArguments:null}],typeArguments:null}],typeArguments:null},{name:"parameters",type:"struct CallParameters",components:[{name:"amount",type:"enum Option",components:[{name:"None",type:"()",components:[],typeArguments:null},{name:"Some",type:"u64",components:null,typeArguments:null}],typeArguments:[{name:"T",type:"u64",components:null,typeArguments:null}]},{name:"asset_id",type:"enum Option",components:[{name:"None",type:"()",components:[],typeArguments:null},{name:"Some",type:"struct ContractId",components:[{name:"value",type:"b256",components:null,typeArguments:null}],typeArguments:null}],typeArguments:[{name:"T",type:"struct ContractId",components:[{name:"value",type:"b256",components:null,typeArguments:null}],typeArguments:null}]},{name:"gas",type:"enum Option",components:[{name:"None",type:"()",components:[],typeArguments:null},{name:"Some",type:"u64",components:null,typeArguments:null}],typeArguments:[{name:"T",type:"u64",components:null,typeArguments:null}]}],typeArguments:null}],typeArguments:null}]}],typeArguments:null}],typeArguments:null}],name:"main",outputs:[{name:"",type:"struct ScriptReturn",components:[{name:"call_returns",type:"[enum Option; 5]",components:[{name:"__array_element",type:"enum Option",components:[{name:"None",type:"()",components:[],typeArguments:null},{name:"Some",type:"enum CallValue",components:[{name:"Value",type:"u64",components:null,typeArguments:null},{name:"Data",type:"(u64, u64)",components:[{name:"__tuple_element",type:"u64",components:null,typeArguments:null},{name:"__tuple_element",type:"u64",components:null,typeArguments:null}],typeArguments:null}],typeArguments:null}],typeArguments:[{name:"T",type:"enum CallValue",components:[{name:"Value",type:"u64",components:null,typeArguments:null},{name:"Data",type:"(u64, u64)",components:[{name:"__tuple_element",type:"u64",components:null,typeArguments:null},{name:"__tuple_element",type:"u64",components:null,typeArguments:null}],typeArguments:null}],typeArguments:null}]}],typeArguments:null}],typeArguments:null}]}];var N="0x90000004470000000000000000000cd45dfcc00110fff3001a5c5000910005b861440006724002d0164114005b40100d360000006158000c61440001504175305f5d10a6504175305d4570a6504171385f5d1027504171385d417027134100007340001a9000001f1a445000910000085d43f0005f4500009000002b504171385d4170271341004073400024900000291a445000910000085d43f0015f4500009000002b360000001a44000050417528504175286041100850457528504170085041700860411008504170085d4100001341000073400037900000396144000c9000003b360000001a440000504174305f5d1086504174305d4570865d43f00210450440504174485f5d108961440001504175405f5d10a8504175405d4570a8504171405f5d1028504171405d417028134100007340004f900000541a445000910000085d43f0005f45000090000060504171405d41702813410040734000599000005e1a445000910000085d43f0015f45000090000060360000001a44000050417538504175386041100850457538504170005041700060411008504170005d410000134100007340006c9000006e6144000690000078504170005d410000134100407340007390000076360000001a44000090000078360000001a4400005d43f00220451400504173805f5d1070504174485d497089504173805d4170701a445000910000105f4520005f450001504175a8504175a8604110105d47f00326440000504470015041726050417260604110a026000000504070011a445000910000105f4500005f440001504174785041747860411010504173505f5c006a5d47f0025d43f00412451400504173005f5d1060504173505d45706a504173005d41706016411400734000a4900000b150496000504173505d41706a5545009010452440504170785041707860411090504170785d41000013410040734001249000031f504972601a445000910000a050411000604120a05041748850417488604110a026000000504070011a445000910000105f4500005f44000150417198504171986041101050517198505574885d454001504174085f5d10815d4540015d43f00310450440504173c85f5d10795d4140005d4d4001504573c85d457079154914c0734800d3900000e12644000050487001504573a85f5d207515453000734400da900000de504573a85d457075284504c0900000de504173a85d417075900000e15f510000504173c85d4170795f5100015d454000504174085d417081104504405d43f0032845540050557198505174785d41400113410000734000f1900000f35d4150019000011c5d455001504174105f5d10825d4550015d41400110450440504173d05f5d107a5d4150005d4d5001504573d05d45707a154914c073480102900001102644000050487001504573b05f5d207615453000734401099000010d504573b05d457076284504c09000010d504173b05d417076900001105f550000504173d05d41707a5f5500015d4940005d455000504174105d417082104504405d414001284524005d417082504171985d450000504171985d41000125450000504574885d43f003254500005041707850450008504171a8504171a860411088504171a850450028504171085041710860411018504171085d41000013410000734001339000013f504171085d450002504175485f5d10a9504175485d4970a91a445000910000185d43f0005f4500005f4520029000017b504171085d41000013410040734001449000016050417108504100085d450000504173e85f5d107d50417108504100085d450001504173785f5d106f504175a85d450000504173e85d41707d10450440504173785d41706f1a485000910000105f4910005f4900011a445000910000185d43f0015f45000050411008604120109000017b50417108504100085d450000504173f05f5d107e50417108504100085d450001504173905f5d1072504175a85d450000504173f05d41707e10450440504173905d4170721a485000910000105f4910005f4900011a445000910000185d43f0015f4500005041100860412010504173085041730860411018504171a850550000504171a85d51000450457308504171a8504d0040504170105041701060411018504170105d410000134100007340018d90000194504170105d450002504175505f5d10aa504175505d4570aa900001a8504170105d4100001341004073400199900001a150417010504100085d450000504174385f5d1087504174385d457087900001a850417010504100085d450000504174505f5d108a504174505d45708a504173205f5d1064504173205d4970641a4450009100003050411000604150205f4540045f45200550417230504172306041103050453000504170285041702860411010504170285d41000013410040734001be900001c5504170285d450001504171485f5d1029504171485d457029900001cd504170285d41000013410000734001ca900001cc1a440000900001cd1a440000504171505f5d102a50453010504170385041703860411028504170385d41000013410040734001d8900001df504170385045000850417358504173586041102050497358900001f1504170385d41000013410000734001e4900001eb1a485000910000205d47f00a104513005041200060411020900001f11a485000910000205d47f00a10451300504120006041102050417158504171586041202050453038504170605041706060411010504170605d41000013410040734001fd90000204504170605d450001504173405f5d1068504173405d4570689000020c504170605d41000013410000734002099000020b1a44a0009000020c1a44a000504173485f5d1069504d7230504171505d49702a50457158504173485d4170692d4d24501a44e000504170705f5d100e504170705d41700e134100007340021d900002281a44d000504175785f5d10af504175785d4570af1a485000910000185d43f0005f4900005f4910029000023d504170705d45700e504173885f5d10711a44d000504174585f5d108b504174585d49708b504173885d4170711a445000910000105f4520005f4500011a485000910000185d43f0015f490000504120086041101050417460504174606041201850457460504171205041712060411018504171205d410000134100007340024990000255504171205d450002504175a05f5d10b4504175a05d4970b41a445000910000185d43f0005f4500005f45200290000309504171205d410000134100407340025a900002b250417120504100085d450000504174285f5d108550417120504100085d450001504173985f5d1073504174285d497085504173985d4170731a445000910000105f4520005f45000150417178504171786041101050557478505171785d4140011341000073400275900002775d455001900002a15d455001504174185f5d10835d4550015d41400110450440504173d85f5d107b5d4150005d4d5001504573d85d45707b154914c073480286900002942644000050487001504573b85f5d2077154530007344028d90000291504573b85d457077284504c090000291504173b85d417077900002945f550000504173d85d41707b5f5500015d4940005d455000504174185d417083104504405d41400128452400504174185d457083504173f85f5d107f504173f85d45707f504173985d4170731a485000910000105f4910005f4900011a445000910000185d43f0015f45000050411008604120109000030950417120504100085d450000504174405f5d108850417120504100085d450001504173a05f5d1074504174405d497088504173a05d4170741a445000910000105f4520005f45000150417188504171886041101050557478505171885d41400113410000734002cd900002cf5d455001900002f95d455001504174205f5d10845d4550015d41400110450440504173e05f5d107c5d4150005d4d5001504573e05d45707c154914c0734802de900002ec2644000050487001504573c05f5d207815453000734402e5900002e9504573c05d457078284504c0900002e9504173c05d417078900002ec5f550000504173e05d41707c5f5500015d4940005d455000504174205d417084104504405d41400128452400504174205d457084504174005f5d1080504174005d457080504173a05d4170741a485000910000105f4910005f4900011a445000910000185d43f0015f4500005041100860412010504173285041732860411018504973281a445000910000205d43f0015f450000504110086041201850417558504175586041102050457260504173505d41706a5549002010491480504575585d43f009284914009000032e504175801a445000910000205d43f0005f450000504175806041102050457260504173505d41706a5549002010491480504575805d43f0092849140050417350504173505d41706a104014005f5d006a9000009d470000000000000000000000000000000000000100000000000002d000000000000000a00000000000000090000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000cfc";var T=new a0(N,o=>{let t=_[0].inputs,e=new E().getCoder(t[0]),n=e.coders.calls.length;if(o.length>n)throw new Error(`At most ${n} calls are supported`);let a=new Uint8Array,r=[];for(let l=0;l<n;l+=1){let c=o[l],u;if(c){let R=M(c.data),z=R.slice(0,8),G=R.slice(8,16).some(X=>X===1),L=R.slice(16),k;G?(k={Data:[a.length,L.length]},a=V([a,L])):k={Value:new P().decode(L,0)[0]},u={contract_id:{value:c.contractId},fn_selector:new P().decode(z,0)[0],fn_arg:k,parameters:{amount:c.amount?Q(c.amount):void 0,asset_id:c.assetId?{value:c.assetId}:void 0,gas:c.gas?Q(c.gas):void 0}}}else u=void 0;r.push(u)}let s={calls:r},i=e.encode(s);return V([i,a])},o=>{if(I(o.code)!==0)throw new Error(`Script returned non-zero result: ${o.code}`);if(o.returnReceipt.type!==o0.ReturnData)throw new Error("Expected returnReceipt to be a ReturnDataReceipt");let t=M(o.returnReceipt.data),e=_[0].outputs,n=new E().getCoder(e[0]),[a,r]=n.decode(t,0),s=t.slice(r),i=[];return a.call_returns.forEach((l,c)=>{if(l)if(l.Data){let[u,R]=l.Data;i[c]=s.slice(I(u),I(u)+I(R))}else i[c]=new P().encode(l.Value)}),i});import{U64Coder as r0}from"@fuel-ts/abi-coder";import{bn as s0}from"@fuel-ts/math";import{ReceiptType as F}from"@fuel-ts/transactions";function i0(o){let t=o.receipts.find(e=>e.type===F.ScriptResult);return(t==null?void 0:t.gasUsed)||s0(0)}var b=class{constructor(t,e,n){this.functionScopes=Array.isArray(t)?t:[t],this.isMultiCall=n,this.value=this.getDecodedValue(e),this.gasUsed=i0(e)}getDecodedValue(t){let n=T.decodeCallResult(t).map((a,r)=>{var l;let{contract:s,func:i}=this.functionScopes[r].getCallConfig();return(l=s.interface.decodeFunctionResult(i,a))==null?void 0:l[0]});return this.isMultiCall?n:n==null?void 0:n[0]}},f=class extends b{constructor(e,n,a,r,s){super(e,a,s);this.transactionResponse=n,this.transactionResult=a,this.transactionId=this.transactionResponse.id,this.contract=r,this.logs=this.getDecodedLogs(a.receipts)}static async build(e,n,a,r){let s=await n.waitForResult();return new f(e,n,s,r,a)}getDecodedLogs(e){return e.reduce((n,a)=>a.type===F.LogData?n.concat(...this.contract.interface.decodeLog(a.data,a.val1.toNumber())):a.type===F.Log?n.concat(...this.contract.interface.decodeLog(new r0().encode(a.val0),a.val1.toNumber())):n,[])}},y=class extends b{constructor(e,n,a){super(e,n,a);this.callResult=n}static async build(e,n,a){return new y(e,n,a)}};function p0(o){let{contract:t,args:e,forward:n,func:a,callParameters:r,bytesOffset:s}=o.getCallConfig(),i=t.interface.encodeFunctionData(a,e,T.getScriptDataOffset()+s);return{contractId:t.id,data:i,assetId:n==null?void 0:n.assetId,amount:n==null?void 0:n.amount,gas:r==null?void 0:r.gasLimit}}var m=class{constructor(t,e){this.functionInvocationScopes=[];this.requiredCoins=[];this.isMultiCall=!1;this.contract=t,this.isMultiCall=e,this.transactionRequest=new c0({gasLimit:l0})}get calls(){return this.functionInvocationScopes.map(t=>p0(t))}static getCallOptions(t){return{fundTransaction:!0,...t}}updateScriptRequest(){let t=this.calls;t.forEach(e=>{this.transactionRequest.addContract(e.contractId)}),this.transactionRequest.setScript(T,t)}getRequiredCoins(){return this.calls.map(e=>({assetId:String(e.assetId),amount:g(e.amount||0)})).concat(this.transactionRequest.calculateFee()).filter(({assetId:e,amount:n})=>e&&!g(n).isZero())}updateRequiredCoins(){let t=this.getRequiredCoins(),e=(n,{assetId:a,amount:r})=>{var i;let s=((i=n.get(a))==null?void 0:i.amount)||g(0);return n.set(a,{assetId:String(a),amount:s.add(r)})};this.requiredCoins=Array.from(t.reduce(e,new Map).values())}addCall(t){return this.addCalls([t]),this}addCalls(t){return this.functionInvocationScopes.push(...t),this.updateScriptRequest(),this.updateRequiredCoins(),this}async prepareTransaction(t){this.updateScriptRequest(),this.updateRequiredCoins(),this.checkGasLimitTotal(),m.getCallOptions(t).fundTransaction&&this.contract.wallet&&await this.fundWithRequiredCoins()}checkGasLimitTotal(){if(this.calls.reduce((e,n)=>e.add(n.gas||0),g(0)).gt(this.transactionRequest.gasLimit))throw new Error("Transaction gasLimit can't be lower than the sum of the forwarded gas of each call")}async getTransactionCost(t){var r;let e=((r=this.contract.wallet)==null?void 0:r.provider)||this.contract.provider;h(e,"Wallet or Provider is required!"),await this.prepareTransaction(t);let n=W(this.transactionRequest);return n.gasPrice=g(U(n.gasPrice)||U((t==null?void 0:t.gasPrice)||0)),await e.getTransactionCost(n,t==null?void 0:t.tolerance)}async fundWithRequiredCoins(){var e;this.transactionRequest.inputs=this.transactionRequest.inputs.filter(n=>n.type!==u0.Coin);let t=await((e=this.contract.wallet)==null?void 0:e.getResourcesToSpend(this.requiredCoins));return this.transactionRequest.addResources(t||[]),this}txParams(t){var n;this.txParameters=t;let e=this.transactionRequest;return e.gasLimit=g(t.gasLimit||e.gasLimit),e.gasPrice=g(t.gasPrice||e.gasPrice),e.addVariableOutputs(((n=this.txParameters)==null?void 0:n.variableOutputs)||0),this}addContracts(t){return t.forEach(e=>this.transactionRequest.addContract(e)),this}async getTransactionRequest(t){return await this.prepareTransaction(t),this.transactionRequest}async call(t){h(this.contract.wallet,"Wallet is required!");let e=await this.getTransactionRequest(t),n=await this.contract.wallet.sendTransaction(e);return f.build(this.functionInvocationScopes,n,this.isMultiCall,this.contract)}async simulate(t){h(this.contract.wallet,"Wallet is required!");let e=await this.getTransactionRequest(t),n=await this.contract.wallet.simulateTransaction(e);return y.build(this.functionInvocationScopes,n,this.isMultiCall)}async dryRun(t){var i;let e=((i=this.contract.wallet)==null?void 0:i.provider)||this.contract.provider;h(e,"Wallet or Provider is required!");let n=await this.getTransactionRequest(t),a=W(n),r=await e.call(a,{utxoValidation:!1});return await y.build(this.functionInvocationScopes,r,this.isMultiCall)}async get(t){return this.dryRun({fundTransaction:!1,...t})}};var S=class extends m{constructor(e,n,a){super(e,!1);this.func=n,this.args=a||[],this.setArguments(...a),super.addCall(this)}getCallConfig(){return{func:this.func,contract:this.contract,callParameters:this.callParameters,txParameters:this.txParameters,forward:this.forward,args:this.args,bytesOffset:this.transactionRequest.bytesOffset||0}}setArguments(...e){return this.args=e||[],this.updateScriptRequest(),this}callParams(e){return this.callParameters=e,e!=null&&e.forward&&(this.forward=d0(e.forward)),this.setArguments(...this.args),this.updateRequiredCoins(),this}};var v=class extends m{constructor(t,e){super(t,!0),this.addCalls(e)}addCall(t){return super.addCalls([t])}addCalls(t){return super.addCalls(t)}};var C=class{constructor(t,e,n=null){this.functions={};this.interface=e instanceof J?e:new J(e),this.id=m0.fromAddressOrString(t),n instanceof f0?(this.provider=n.provider,this.wallet=n):(this.provider=n,this.wallet=null),Object.keys(this.interface.functions).forEach(a=>{let r=this.interface.getFunction(a);Object.defineProperty(this.functions,r.name,{value:this.buildFunction(r),writable:!1})})}buildFunction(t){return(...e)=>new S(this,t,e)}multiCall(t){return new v(this,t)}};var T0=new y0("0.21.0"),A=class{constructor(t,e,n=null){this.bytecode=t,e instanceof j?this.interface=e:this.interface=new j(e),n instanceof R0?(this.provider=n.provider,this.wallet=n):n instanceof h0?(this.provider=n,this.wallet=null):(this.provider=null,this.wallet=null)}connect(t){return new A(this.bytecode,this.interface,t)}async deployContract(t){var l;if(!this.wallet)return T0.throwArgumentError("Cannot deploy without wallet","wallet",this.wallet);let e=(l=t==null?void 0:t.storageSlots)==null?void 0:l.map(({key:c,value:u})=>({key:w(c),value:w(u)})).sort(({key:c},{key:u})=>c.localeCompare(u)),n={salt:g0(32),...t,storageSlots:e||[]},a=n.stateRoot||x(n.storageSlots),r=q(this.bytecode,n.salt,a),s=new C0({gasPrice:0,gasLimit:A0,bytecodeWitnessIndex:0,witnesses:[this.bytecode],...n});return s.addContractCreatedOutput(r,a),await this.wallet.fund(s),await(await this.wallet.sendTransaction(s)).wait(),new C(r,this.interface,this.wallet)}};export{C as Contract,A as ContractFactory,D as ContractUtils,f as FunctionInvocationResult,S as FunctionInvocationScope,b as InvocationResult,v as MultiCallInvocationScope};
//# sourceMappingURL=index.mjs.map